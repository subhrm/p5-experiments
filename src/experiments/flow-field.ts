/**
 * Perlin Noise Flow Field Experiment
 * Particles follow a flow field generated by Perlin noise
 */
import p5 from 'p5';

const sketch = (p: p5): void => {
    let particles: p5.Vector[] = [];
    const numParticles: number = 2000;
    const noiseScale: number = 0.01;

    p.setup = (): void => {
        const canvas = p.createCanvas(p.windowWidth, p.windowHeight - 60);
        canvas.parent('canvas-container');

        // Use HSB color mode for rainbow effects
        p.colorMode(p.HSB, 360, 100, 100, 1);

        // Initialize particles
        for (let i = 0; i < numParticles; i++) {
            particles.push(p.createVector(p.random(p.width), p.random(p.height)));
        }

        p.background(0);
    };

    p.draw = (): void => {
        // Create trail effect with translucent overlay
        p.noStroke();
        p.fill(0, 0, 0, 0.05);
        p.rect(0, 0, p.width, p.height);

        // Update and draw particles
        for (let i = 0; i < numParticles; i++) {
            const particle = particles[i];

            // Get noise value based on position
            const n = p.noise(particle.x * noiseScale, particle.y * noiseScale);
            const angle = p.map(n, 0, 1, 0, p.TWO_PI * 2);

            // Create velocity vector from angle
            const v = p5.Vector.fromAngle(angle);
            v.setMag(1);

            // Move particle
            particle.add(v);

            // Draw particle with color based on angle
            const hue = p.map(angle, 0, p.TWO_PI * 2, 0, 360);
            p.stroke(hue, 80, 100, 0.8);
            p.strokeWeight(2);
            p.point(particle.x, particle.y);

            // Wrap around edges
            if (!onScreen(particle)) {
                particle.x = p.random(p.width);
                particle.y = p.random(p.height);
            }
        }
    };

    const onScreen = (v: p5.Vector): boolean => {
        return v.x >= 0 && v.x <= p.width && v.y >= 0 && v.y <= p.height;
    };

    p.windowResized = (): void => {
        p.resizeCanvas(p.windowWidth, p.windowHeight - 60);
        p.background(0);
    };
};

export default new p5(sketch);
