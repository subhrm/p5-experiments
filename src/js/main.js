/**
 * Main Application Router
 * Handles navigation between home page and experiments
 */

// Experiments Registry
const experiments = [
    {
        id: 'particle-click',
        title: 'Particle Click',
        description: 'Click anywhere to create a burst of colorful particles with physics-based animation.',
        icon: 'âœ¨',
        module: () => import('../experiments/particle-click.js')
    },
    {
        id: 'flow-field',
        title: 'Perlin Noise Flow Field',
        description: 'Thousands of particles flow through a vector field generated by Perlin noise, creating organic swirling patterns.',
        icon: 'ðŸŒŠ',
        module: () => import('../experiments/flow-field.js')
    },
    {
        id: 'lorenz-attractor',
        title: 'Lorenz Attractor',
        description: '3D visualization of chaos theory\'s famous "butterfly effect" strange attractor. Drag to rotate.',
        icon: 'ðŸ¦‹',
        module: () => import('../experiments/lorenz-attractor.js')
    }
];

// Current p5 instance (to clean up when navigating away)
let currentP5Instance = null;

/**
 * Render experiment cards to the grid
 */
function renderExperiments() {
    const grid = document.getElementById('experiments-grid');
    if (!grid) return;

    grid.innerHTML = experiments.map(exp => `
        <a href="#${exp.id}" class="experiment-card" data-id="${exp.id}">
            <div class="experiment-card__preview">
                <span class="experiment-card__preview-icon">${exp.icon}</span>
            </div>
            <div class="experiment-card__content">
                <h3 class="experiment-card__title">${exp.title}</h3>
                <p class="experiment-card__description">${exp.description}</p>
                <div class="experiment-card__arrow">â†’</div>
            </div>
        </a>
    `).join('');
}

/**
 * Show home view
 */
function showHome() {
    // Clean up any existing p5 instance
    if (currentP5Instance) {
        currentP5Instance.remove();
        currentP5Instance = null;
    }

    // Clear canvas container
    const container = document.getElementById('canvas-container');
    if (container) {
        container.innerHTML = '';
    }

    document.getElementById('home-view').style.display = '';
    document.getElementById('experiment-view').style.display = 'none';
    document.getElementById('footer').style.display = '';
    document.title = 'P5.js Experiments';
}

/**
 * Show experiment view
 */
async function showExperiment(experimentId) {
    const experiment = experiments.find(e => e.id === experimentId);
    if (!experiment) {
        showHome();
        return;
    }

    // Clean up any existing p5 instance
    if (currentP5Instance) {
        currentP5Instance.remove();
        currentP5Instance = null;
    }

    // Clear canvas container
    const container = document.getElementById('canvas-container');
    if (container) {
        container.innerHTML = '';
    }

    // Update UI
    document.getElementById('home-view').style.display = 'none';
    document.getElementById('experiment-view').style.display = '';
    document.getElementById('footer').style.display = 'none';
    document.getElementById('experiment-title').textContent = experiment.title;
    document.title = `${experiment.title} | P5.js Experiments`;

    // Load and run the experiment module
    try {
        const module = await experiment.module();
        // The module should export a sketch function and return a p5 instance
        if (module.default) {
            currentP5Instance = module.default;
        }
    } catch (error) {
        console.error('Failed to load experiment:', error);
        container.innerHTML = `<p style="color: white; text-align: center; padding: 2rem;">Failed to load experiment</p>`;
    }
}

/**
 * Handle hash-based routing
 */
function handleRoute() {
    const hash = window.location.hash.slice(1); // Remove the '#'

    if (hash && experiments.find(e => e.id === hash)) {
        showExperiment(hash);
    } else {
        showHome();
    }
}

/**
 * Initialize the application
 */
function init() {
    renderExperiments();

    // Handle back button
    document.getElementById('back-button').addEventListener('click', (e) => {
        e.preventDefault();
        window.location.hash = '';
    });

    // Handle hash changes
    window.addEventListener('hashchange', handleRoute);

    // Initial route
    handleRoute();
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', init);
