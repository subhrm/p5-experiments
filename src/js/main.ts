/**
 * Main Application Router
 * Handles navigation between home page and experiments
 */
import type p5 from 'p5';

/**
 * Experiment definition interface
 */
interface Experiment {
    id: string;
    title: string;
    description: string;
    icon: string;
    module: () => Promise<{ default: p5 }>;
}

// Experiments Registry
const experiments: Experiment[] = [
    {
        id: 'particle-click',
        title: 'Particle Click',
        description: 'Click anywhere to create a burst of colorful particles with physics-based animation.',
        icon: 'âœ¨',
        module: () => import('../experiments/particle-click')
    },
    {
        id: 'flow-field',
        title: 'Perlin Noise Flow Field',
        description: 'Thousands of particles flow through a vector field generated by Perlin noise, creating organic swirling patterns.',
        icon: 'ðŸŒŠ',
        module: () => import('../experiments/flow-field')
    },
    {
        id: 'lorenz-attractor',
        title: 'Lorenz Attractor',
        description: '3D visualization of chaos theory\'s famous "butterfly effect" strange attractor. Drag to rotate.',
        icon: 'ðŸ¦‹',
        module: () => import('../experiments/lorenz-attractor')
    }
];

// Current p5 instance (to clean up when navigating away)
let currentP5Instance: p5 | null = null;

/**
 * Render experiment cards to the grid
 */
function renderExperiments(): void {
    const grid = document.getElementById('experiments-grid');
    if (!grid) return;

    grid.innerHTML = experiments.map(exp => `
        <a href="#${exp.id}" class="experiment-card" data-id="${exp.id}">
            <div class="experiment-card__preview">
                <span class="experiment-card__preview-icon">${exp.icon}</span>
            </div>
            <div class="experiment-card__content">
                <h3 class="experiment-card__title">${exp.title}</h3>
                <p class="experiment-card__description">${exp.description}</p>
                <div class="experiment-card__arrow">â†’</div>
            </div>
        </a>
    `).join('');
}

/**
 * Show home view
 */
function showHome(): void {
    // Clean up any existing p5 instance
    if (currentP5Instance) {
        currentP5Instance.remove();
        currentP5Instance = null;
    }

    // Clear canvas container
    const container = document.getElementById('canvas-container');
    if (container) {
        container.innerHTML = '';
    }

    const homeView = document.getElementById('home-view');
    const experimentView = document.getElementById('experiment-view');
    const footer = document.getElementById('footer');

    if (homeView) homeView.style.display = '';
    if (experimentView) experimentView.style.display = 'none';
    if (footer) footer.style.display = '';
    document.title = 'P5.js Experiments';
}

/**
 * Show experiment view
 */
async function showExperiment(experimentId: string): Promise<void> {
    const experiment = experiments.find(e => e.id === experimentId);
    if (!experiment) {
        showHome();
        return;
    }

    // Clean up any existing p5 instance
    if (currentP5Instance) {
        currentP5Instance.remove();
        currentP5Instance = null;
    }

    // Clear canvas container
    const container = document.getElementById('canvas-container');
    if (container) {
        container.innerHTML = '';
    }

    // Update UI
    const homeView = document.getElementById('home-view');
    const experimentView = document.getElementById('experiment-view');
    const footer = document.getElementById('footer');
    const experimentTitle = document.getElementById('experiment-title');

    if (homeView) homeView.style.display = 'none';
    if (experimentView) experimentView.style.display = '';
    if (footer) footer.style.display = 'none';
    if (experimentTitle) experimentTitle.textContent = experiment.title;
    document.title = `${experiment.title} | P5.js Experiments`;

    // Load and run the experiment module
    try {
        const module = await experiment.module();
        // The module should export a sketch function and return a p5 instance
        if (module.default) {
            currentP5Instance = module.default;
        }
    } catch (error) {
        console.error('Failed to load experiment:', error);
        if (container) {
            container.innerHTML = `<p style="color: white; text-align: center; padding: 2rem;">Failed to load experiment</p>`;
        }
    }
}

/**
 * Handle hash-based routing
 */
function handleRoute(): void {
    const hash = window.location.hash.slice(1); // Remove the '#'

    if (hash && experiments.find(e => e.id === hash)) {
        showExperiment(hash);
    } else {
        showHome();
    }
}

/**
 * Initialize the application
 */
function init(): void {
    renderExperiments();

    // Handle back button
    const backButton = document.getElementById('back-button');
    if (backButton) {
        backButton.addEventListener('click', (e: Event) => {
            e.preventDefault();
            window.location.hash = '';
        });
    }

    // Handle hash changes
    window.addEventListener('hashchange', handleRoute);

    // Initial route
    handleRoute();
}

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', init);
